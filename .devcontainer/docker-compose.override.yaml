name: lumigator

services:

  backend:
    build:
      context: .
      dockerfile: "Dockerfile"
      target: "dev_image"
    volumes:
      -  database_volume:/mzai/backend/local.db
    ports:
      - "5678:5678"
    environment:
      - MLFLOW_TRACKING_URI
    depends_on:
      mlflow:
        condition: "service_started"
        required: false
    develop:
      watch:
        - path: lumigator/python/mzai/backend/
          target: /mzai/lumigator/python/mzai/backend
          action: sync
          ignore:
            - .venv/
        - path: lumigator/python/mzai/jobs/
          target: /mzai/lumigator/python/mzai/jobs
          action: sync
          ignore:
            - .venv/
        - path: lumigator/python/mzai/schemas/
          target: /mzai/lumigator/python/mzai/schemas
          action: sync
          ignore:
            - .venv/
        - path: lumigator/python/mzai/backend/pyproject.toml
          action: rebuild

  mlflow:
    image: ghcr.io/mlflow/mlflow:v2.0.1
    environment:
      - MLFLOW_TRACKING_URI=${MLFLOW_TRACKING_URI}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_DEFAULT_REGION=${AWS_DEFAULT_REGION}
      - BACKEND_STORE_URI=sqlite:///mlflow.db
      - ARTIFACT_ROOT=s3://mlflow`
    ports:
      - "8001:5000"
    depends_on:
      minio:
        condition: service_healthy
    command: mlflow server --backend-store-uri ${BACKEND_STORE_URI} --default-artifact-root ${ARTIFACT_ROOT} --host 0.0.0.0
    extra_hosts:
      - "localhost:host-gateway"
    profiles:
      - local
